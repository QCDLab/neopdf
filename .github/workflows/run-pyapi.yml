name: Run the Python-API tests üêç

on: [push]

jobs:
  pyapi:
    # `ubuntu-24.04` doesn't support Python 3.7 anymore
    runs-on: ubuntu-22.04
    container: ghcr.io/radonirinaunimi/neopdf-container:latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust ü¶Ä
        run: |
          rustup component add llvm-tools
      - name: Run the Python tests üöÄ
        env:
          # `-C link-dead-code` is needed to prevent 'warning: XX functions have mismatched data' warnings
          RUSTFLAGS: '-Cinstrument-coverage -Clink-dead-code'
        run: |
          cd neopdf_pyapi
          # Mock virtual environment
          export VIRTUAL_ENV=$(python3 -c "import sys; print(sys.prefix)")
          export PATH="$VIRTUAL_ENV/bin:$PATH"
          cargo install --locked maturin
          maturin develop --release --extras test
          # Use the PDF sets downloaded in the container
          export NEOPDF_DATA_PATH=/usr/share/LHAPDF
          pytest
